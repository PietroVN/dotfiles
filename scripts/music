#!/usr/bin/env bash
#
# Simple Music Script
# By: PietroVN
# Requirements: youtube-dl, mpv, socat
# Usage:
# 	music <command)
# 	seek  <time>
#	pause <yes/no>
# 	loop  <yes/no>
# 	quit
# 	e.g music play hollow knight ost

# get args (music name | command)
COMMAND=$@

# Commands
run_command () {
		# Quit
		if [[ ${COMMAND} == "quit" ]]; then
			echo '{ "command": ["quit"] }' | socat - ${XDG_RUNTIME_DIR}/mpvsocket > /dev/null
		fi

		# Seek
		if [[ ${COMMAND} == *"seek"* ]]; then
			sed "s/SEEK/$(echo ${COMMAND} | awk '{print $2}')/g" <<< '{ "command": ["set_property", "playback-time", "SEEK"] }'  | socat - ${XDG_RUNTIME_DIR}/mpvsocket > /dev/null
		fi

		# Pause
		if [[ ${COMMAND} == *"pause"* ]]; then
			sed "s/STATE/$(echo ${COMMAND} | awk '{print $2}')/g" <<<'{ "command": ["set_property", "pause", "STATE"] }' | socat - ${XDG_RUNTIME_DIR}/mpvsocket > /dev/null
		fi

		# Play
		if [[ ${COMMAND} == *"play"* ]]; then

				# End already running mpv process
				if [[ $(pgrep -f mpv) ]]; then
						killall mpv
				fi
				
				COMMAND=$(sed s/play//g <<< ${COMMAND})
				
				# Play song
				if [[ ${COMMAND} != *"https"* ]]; then
						mpv --no-terminal --no-video --input-ipc-server=${XDG_RUNTIME_DIR}/mpvsocket $(youtube-dl --get-url ytsearch:"${COMMAND}") &
				else
						mpv --no-terminal --no-video --input-ipc-server=${XDG_RUNTIME_DIR}/mpvscoket ${COMMAND} &
				fi

				# Wait for mpv start
				sleep 5

				# Re-enable previous options
				if [[ ${LOOP} == "yes" ]]; then
						echo '{ "command": ["set_property", "loop", "yes"] }' | socat - ${XDG_RUNTIME_DIR}/mpvsocket > /dev/null
				fi
		fi
		
		# Loop
	    if [[ ${COMMAND} == *"loop"* ]]; then
				sed "s/STATE/$(echo ${COMMAND} | awk '{print $2}')/g" <<<'{ "command": ["set_property", "loop", "STATE"] }' | socat - ${XDG_RUNTIME_DIR}/mpvsocket > /dev/null
				LOOP=$(echo ${COMMAND} | awk '{print $2}')
        fi
}

# Check if command is empty
if [[ -z ${COMMAND} ]]; then
		echo "You need to enter a music name/link or a command"
		exit
fi

# Check if mpv is playing anything
if [[ ${COMMAND} != *"play"* && ! $(pgrep -f mpv) ]]; then
		echo "No MPV process detected, first you need to run: music play <music name/link>"
		exit
fi

# Run command function
run_command
